<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-screen {
            padding: 60px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-decoration: underline;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Dashboard */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 0;
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px 30px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar li:hover, .sidebar li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Session status indicator */
        .session-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }

        .session-indicator.warning {
            background: #f39c12;
        }

        /* Appointments */
        .appointment-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .appointment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #f39c12;
        }

        .status-approved {
            background: #27ae60;
        }

        .status-denied {
            background: #e74c3c;
        }

        /* Mental Health Tests */
        .test-card {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .test-card:hover {
            transform: translateY(-3px);
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .question h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .radio-option:hover {
            background: #e9ecef;
        }

        .test-result {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* Admin specific styles */
        .admin-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .action-buttons {
            margin-top: 15px;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-deny {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 20px 0;
            }
            
            .sidebar ul {
                display: flex;
                overflow-x: auto;
            }
            
            .sidebar li {
                white-space: nowrap;
                min-width: 150px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Session status indicator -->
    <div id="sessionIndicator" class="session-indicator hidden">
        Session Active
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2>Patient Portal Login</h2>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Remember me (30 days)</label>
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="showSignup()">Create Account</button>
                <button class="link-btn" onclick="showAdminLogin()">Staff Login</button>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signupScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Create Account</h2>
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="signupPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="signupPhone" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label>Gender:</label>
                    <select id="signupGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <button class="btn" onclick="signup()">Create Account</button>
                <button class="link-btn" onclick="showLogin()">Back to Login</button>
            </div>
        </div>

        <!-- Admin Login Screen -->
        <div id="adminLoginScreen" class="login-screen hidden">
            <div class="login-form">
                <h2>Staff Login</h2>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="adminUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter password">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="adminRememberMe">
                    <label for="adminRememberMe">Remember me</label>
                </div>
                <button class="btn" onclick="adminLogin()">Login</button>
                <button class="link-btn" onclick="showLogin()">Back to Patient Login</button>
            </div>
        </div>

        <!-- Patient Dashboard -->
        <div id="patientDashboard" class="dashboard hidden">
            <button class="logout-btn" onclick="logout()">Logout</button>
            <div class="sidebar">
                <h3>Patient Portal</h3>
                <ul>
                    <li class="active" onclick="showSection('appointments')">Manage Appointments</li>
                    <li onclick="showSection('mentalHealth')">Mental Health Tests</li>
                    <li onclick="showSection('healthRecords')">Health Records</li>
                    <li onclick="showSection('profile')">Profile</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Appointments Section -->
                <div id="appointmentsSection" class="section">
                    <h2>Manage Appointments</h2>
                    <div id="appointmentsList"></div>
                    <button class="btn" onclick="showBookingForm()">Book New Appointment</button>
                    
                    <!-- Booking Form -->
                    <div id="bookingForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Book New Appointment</h3>
                        <div class="form-group">
                            <label>Preferred Appointment Time:</label>
                            <select id="appointmentTime">
                                <option value="">Select Time</option>
                                <option value="thursday-1-2pm">Thursday 1-2 PM</option>
                                <option value="friday-1-2pm">Friday 1-2 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reason for Visit:</label>
                            <textarea id="appointmentReason" placeholder="Please describe the reason for your visit"></textarea>
                        </div>
                        <button class="btn" onclick="bookAppointment()">Submit Request</button>
                        <button class="btn btn-secondary" onclick="hideBookingForm()">Cancel</button>
                    </div>
                </div>

                <!-- Mental Health Tests Section -->
                <div id="mentalHealthSection" class="section hidden">
                    <h2>Mental Health Tests</h2>
                    <div class="test-card" onclick="startTest('depression')">
                        <h3>Depression Screening (PHQ-9)</h3>
                        <p>Take a self-assessment to screen for depression symptoms</p>
                    </div>
                    <div class="test-card" onclick="startTest('anxiety')">
                        <h3>Anxiety Screening (GAD-7)</h3>
                        <p>Take a self-assessment to screen for anxiety symptoms</p>
                    </div>
                    <div class="test-card" onclick="startTest('adhd')">
                        <h3>ADHD Screening</h3>
                        <p>Take a self-assessment to screen for ADHD symptoms</p>
                    </div>
                    <div id="testResults"></div>
                </div>

                <!-- Test Taking Interface -->
                <div id="testInterface" class="section hidden">
                    <h2 id="testTitle"></h2>
                    <div id="testQuestions"></div>
                    <button class="btn" onclick="submitTest()">Submit Test</button>
                    <button class="btn btn-secondary" onclick="cancelTest()">Cancel</button>
                </div>

                <!-- Health Records Section -->
                <div id="healthRecordsSection" class="section hidden">
                    <h2>Health Records</h2>
                    <p>Your health records and medical history will be displayed here.</p>
                    <div id="healthRecordsList"></div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden">
                    <h2>Profile</h2>
                    <div id="profileInfo"></div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <button class="logout-btn" onclick="logout()">Logout</button>
            <div class="sidebar">
                <h3>Admin Portal</h3>
                <ul>
                    <li class="active" onclick="showAdminSection('appointments')">Appointment Requests</li>
                    <li onclick="showAdminSection('patients')">Patient Management</li>
                    <li onclick="showAdminSection('testResults')">Test Results</li>
                </ul>
            </div>
            <div class="main-content">
                <!-- Admin Appointments Section -->
                <div id="adminAppointmentsSection" class="section">
                    <h2>Appointment Requests</h2>
                    <div id="adminAppointmentsList"></div>
                </div>

                <!-- Admin Patients Section -->
                <div id="adminPatientsSection" class="section hidden">
                    <h2>Patient Management</h2>
                    <button class="btn" onclick="showAddPatientForm()">Add New Patient</button>
                    <div id="patientsList"></div>
                    
                    <!-- Add Patient Form -->
                    <div id="addPatientForm" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Add New Patient</h3>
                        <div class="form-group">
                            <label>Full Name:</label>
                            <input type="text" id="newPatientName">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="newPatientEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone:</label>
                            <input type="tel" id="newPatientPhone">
                        </div>
                        <div class="form-group">
                            <label>Gender:</label>
                            <select id="newPatientGender">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer-not-to-say">Prefer not to say</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addPatient()">Add Patient</button>
                        <button class="btn btn-secondary" onclick="hideAddPatientForm()">Cancel</button>
                    </div>
                </div>

                <!-- Admin Test Results Section -->
                <div id="adminTestResultsSection" class="section hidden">
                    <h2>Patient Test Results</h2>
                    <div id="adminTestResultsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentTest = null;
        let currentTestAnswers = [];
        let isAdmin = false;
        let sessionTimer = null;
        let sessionExpiryTime = null;

        // Session configuration (in milliseconds)
        const SESSION_DURATION = 15 * 60 * 1000; // 15 minutes for regular session
        const REMEMBER_ME_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 days for remember me
        const SESSION_WARNING_TIME = 2 * 60 * 1000; // Show warning 2 minutes before expiry

        // Storage manager for persistent data
        const StorageManager = {
            // Save data to memory (simulate database)
            saveToStorage: function(key, data) {
                // In a real app, this would save to a database via API
                // For demo purposes, we'll use a persistent object
                if (!window.persistentData) {
                    window.persistentData = {};
                }
                window.persistentData[key] = data;
            },

            // Load data from memory
            loadFromStorage: function(key) {
                if (window.persistentData && window.persistentData[key]) {
                    return window.persistentData[key];
                }
                return null;
            },

            // Session management with tokens
            setSessionToken: function(user, rememberMe = false) {
                const sessionData = {
                    userId: user.id,
                    isAdmin: isAdmin,
                    loginTime: Date.now(),
                    expiryTime: Date.now() + (rememberMe ? REMEMBER_ME_DURATION : SESSION_DURATION),
                    rememberMe: rememberMe
                };
                
                // Store session data
                this.saveToStorage('currentSession', sessionData);
                sessionExpiryTime = sessionData.expiryTime;
                
                // Start session monitoring
                this.startSessionMonitoring();
                this.updateSessionIndicator();
            },

            getCurrentSession: function() {
                return this.loadFromStorage('currentSession');
            },

            clearSession: function() {
                this.saveToStorage('currentSession', null);
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                this.hideSessionIndicator();
            },

            isSessionValid: function() {
                const sessionData = this.getCurrentSession();
                if (!sessionData) return false;
                
                return Date.now() < sessionData.expiryTime;
            },

            refreshSession: function() {
                const sessionData = this.getCurrentSession();
                if (sessionData && !sessionData.rememberMe) {
                    // Extend session by SESSION_DURATION
                    sessionData.expiryTime = Date.now() + SESSION_DURATION;
                    this.saveToStorage('currentSession', sessionData);
                    sessionExpiryTime = sessionData.expiryTime;
                }
            },

            startSessionMonitoring: function() {
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                }
                
                sessionTimer = setInterval(() => {
                    if (!this.isSessionValid()) {
                        alert('Your session has expired. Please log in again.');
                        logout();
                        return;
                    }
                    
                    // Show warning before expiry
                    const timeLeft = sessionExpiryTime - Date.now();
                    if (timeLeft <= SESSION_WARNING_TIME && timeLeft > 0) {
                        this.showSessionWarning();
                    }
                    
                    this.updateSessionIndicator();
                }, 60000); // Check every minute
            },

            showSessionWarning: function() {
                const timeLeft = Math.floor((sessionExpiryTime - Date.now()) / 60000);
                const indicator = document.getElementById('sessionIndicator');
                indicator.className = 'session-indicator warning';
                indicator.textContent = `Session expires in ${timeLeft} min`;
                
                if (confirm(`Your session will expire in ${timeLeft} minutes. Would you like to extend it?`)) {
                    this.refreshSession();
                }
            },

            updateSessionIndicator: function() {
                const indicator = document.getElementById('sessionIndicator');
                const sessionData = this.getCurrentSession();
                
                if (sessionData) {
                    const timeLeft = Math.floor((sessionExpiryTime - Date.now()) / 60000);
                    indicator.classList.remove('hidden');
                    
                    if (timeLeft > SESSION_WARNING_TIME / 60000) {
                        indicator.className = 'session-indicator';
                        indicator.textContent = `Session Active (${timeLeft} min left)`;
                    }
                } else {
                    this.hideSessionIndicator();
                }
            },

            hideSessionIndicator: function() {
                document.getElementById('sessionIndicator').classList.add('hidden');
            }
        };

        // Initialize data structures with persistent storage
        function initializeData() {
            // Load existing data or create new
            window.users = StorageManager.loadFromStorage('users') || [];
            window.appointments = StorageManager.loadFromStorage('appointments') || [];
            window.testResults = StorageManager.loadFromStorage('testResults') || [];

            // Create demo account if none exists
            if (window.users.length === 0) {
                const demoPatient = {
                    id: 1,
                    name: 'John Doe',
                    email: 'demo@patient.com',
                    password: 'demo123',
                    phone: '555-0123',
                    gender: 'male',
                    createdAt: new Date().toISOString()
                };
                window.users.push(demoPatient);
                StorageManager.saveToStorage('users', window.users);
            }
        }

        // Save data whenever it changes
        function saveData() {
            StorageManager.saveToStorage('users', window.users);
            StorageManager.saveToStorage('appointments', window.appointments);
            StorageManager.saveToStorage('testResults', window.testResults);
        }

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'healthcare2024'
        };

        // Mental health test questions (same as before)
        const testQuestions = {
            depression: {
                title: 'Depression Screening (PHQ-9)',
                questions: [
                    'Little interest or pleasure in doing things',
                    'Feeling down, depressed, or hopeless',
                    'Trouble falling or staying asleep, or sleeping too much',
                    'Feeling tired or having little energy',
                    'Poor appetite or overeating',
                    'Feeling bad about yourself — or that you are a failure or have let yourself or your family down',
                    'Trouble concentrating on things, such as reading the newspaper or watching television',
                    'Moving or speaking so slowly that other people could have noticed. Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual',
                    'Thoughts that you would be better off dead, or of hurting yourself in some way'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal depression symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild depression symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate depression symptoms' },
                        { min: 15, max: 19, level: 'Moderately Severe', description: 'Moderately severe depression symptoms' },
                        { min: 20, max: 27, level: 'Severe', description: 'Severe depression symptoms' }
                    ]
                }
            },
            anxiety: {
                title: 'Anxiety Screening (GAD-7)',
                questions: [
                    'Feeling nervous, anxious, or on edge',
                    'Not being able to stop or control worrying',
                    'Worrying too much about different things',
                    'Trouble relaxing',
                    'Being so restless that it is hard to sit still',
                    'Becoming easily annoyed or irritable',
                    'Feeling afraid, as if something awful might happen'
                ],
                options: [
                    { text: 'Not at all', value: 0 },
                    { text: 'Several days', value: 1 },
                    { text: 'More than half the days', value: 2 },
                    { text: 'Nearly every day', value: 3 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 4, level: 'Minimal', description: 'Minimal anxiety symptoms' },
                        { min: 5, max: 9, level: 'Mild', description: 'Mild anxiety symptoms' },
                        { min: 10, max: 14, level: 'Moderate', description: 'Moderate anxiety symptoms' },
                        { min: 15, max: 21, level: 'Severe', description: 'Severe anxiety symptoms' }
                    ]
                }
            },
            adhd: {
                title: 'ADHD Screening',
                questions: [
                    'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?',
                    'How often do you have difficulty getting things in order when you have to do a task that requires organization?',
                    'How often do you have problems remembering appointments or obligations?',
                    'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?',
                    'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?',
                    'How often do you feel overly active and compelled to do things, like you were driven by a motor?'
                ],
                options: [
                    { text: 'Never', value: 0 },
                    { text: 'Rarely', value: 1 },
                    { text: 'Sometimes', value: 2 },
                    { text: 'Often', value: 3 },
                    { text: 'Very Often', value: 4 }
                ],
                scoring: {
                    ranges: [
                        { min: 0, max: 8, level: 'Low', description: 'Low likelihood of ADHD symptoms' },
                        { min: 9, max: 13, level: 'Moderate', description: 'Moderate likelihood of ADHD symptoms' },
                        { min: 14, max: 24, level: 'High', description: 'High likelihood of ADHD symptoms' }
                    ]
                }
            }
        };

        // Authentication functions with session management
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!email || !password) {
                alert('Please
